---
- name: All hosts up-to-date
  hosts: cluster
  become: yes
  vars:
    consulkey: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63626131613563653963306134386337613532323239333533326234653665633965333761646535
          6133616134343731383662343262306666656331623737330a373336373337393636623438363538
          35303931643162363133653138306331396163393562306630343339353963343664633734626265
          6130373137353534620a326463373833346231383263316130383461643931323366343763386638
          66666363616630646138356565363338363234646137343936623763356363363563613266356263
          6630363863313439306665306234373235623965663939303363
  vars_files:
    - consul/consul_secrets.yml
  tasks:
    - name: install consul
      pacman:
        update_cache: yes
        name:
          - consul
    - name: mkdir /etc/consul.d/certs
      file:
        owner: consul
        group: consul
        path: /etc/consul.d/certs
        state: directory
    - name: copy consul ca root cert
      copy:
        src: 'consul/consul-ca/consul-agent-ca.pem'
        dest: /etc/consul.d/certs/
        owner: consul
        group: consul
        mode: '664'
    - name: copy consul ca cert
      copy:
        src: 'consul/consul-ca/dc1-server-consul-{{ansible_hostname}}.pem'
        dest: /etc/consul.d/certs/
        owner: consul
        group: consul
        mode: '664'
    - name: copy consul ca key
      copy:
        src: 'consul/consul-ca/dc1-server-consul-{{ansible_hostname}}-key.pem'
        dest: /etc/consul.d/certs/
        owner: consul
        group: consul
        mode: '660'
    - name: generate consul.hcl
      template:
        src: 'consul/consul.hcl.j2'
        dest: /etc/consul.d/consul.hcl
      register: consul_conf
    - name: mkdir /etc/systemd/system/consul.service.d/
      file:
        owner: consul
        group: consul
        path: /etc/systemd/system/consul.service.d/
        state: directory
    - name: copy consul override file
      copy:
        src: 'consul/consul-override.conf'
        dest: /etc/systemd/system/consul.service.d/override.conf
    - name: systemctl daemon-reload
      command:
        cmd: 'systemctl daemon-reload'
    - name: mkdir /opt/consul
      file:
        owner: consul
        group: consul
        path: /opt/consul
        state: directory
    - name: Ensure consul is started and enabled
      service:
        name: consul
        state: started
        enabled: yes
    - name: Reload consul if consul.hcl has changed
      service:
        name: consul
        state: restarted
      when: consul_conf.changed
